<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invest Now</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f4f4f4;
        }

        .plan-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .plan-button {
            padding: 15px 30px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }

        .plan-button:hover {
            background: #0056b3;
        }

        .plan-section {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 5px;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.1);
            margin: auto;
            width: 50%;
        }

        .active {
            display: block;
        }

        select,
        button {
            padding: 10px;
            margin: 10px;
            font-size: 16px;
        }
    </style>
</head>

<body>

    <h2>Select Your Investment Plan</h2>

    <!-- Investment Plan Buttons -->
    <div class="plan-buttons">
        <button class="plan-button" onclick="showPlan('basic')">Basic Plan</button>
        <button class="plan-button" onclick="showPlan('standard')">Standard Plan</button>
        <button class="plan-button" onclick="showPlan('vip')">VIP Plan</button>
    </div>

    <!-- Investment Plan Sections -->
    <div id="basic" class="plan-section">
        <h3>Basic Plan</h3>
        <select id="amount_basic">
            <option value="0.007">Invest $20 → Earn $100</option>
            <option value="30">Invest $30 → Earn $150</option>
            <option value="40">Invest $40 → Earn $200</option>
            <option value="50">Invest $50 → Earn $250</option>
            <option value="60">Invest $60 → Earn $300</option>
            <option value="70">Invest $70 → Earn $350</option>
            <option value="80">Invest $80 → Earn $400</option>
            <option value="90">Invest $90 → Earn $450</option>
        </select>
        <button onclick="convertAndPay('basic')">Pay Now</button>
    </div>

    <div id="standard" class="plan-section">
        <h3>Standard Plan</h3>
        <select id="amount_standard">
            <option value="100">Invest $100 → Earn $500</option>
            <option value="150">Invest $150 → Earn $750</option>
            <option value="200">Invest $200 → Earn $1000</option>
            <option value="250">Invest $250 → Earn $1250</option>
            <option value="300">Invest $300 → Earn $1500</option>
            <option value="350">Invest $350 → Earn $1750</option>
        </select>
        <button onclick="convertAndPay('standard')">Pay Now</button>
    </div>

    <div id="vip" class="plan-section">
        <h3>VIP Plan</h3>
        <select id="amount_vip">
            <option value="400">Invest $400 → Earn $2000</option>
            <option value="500">Invest $500 → Earn $2500</option>
            <option value="600">Invest $600 → Earn $3000</option>
            <option value="700">Invest $700 → Earn $3500</option>
            <option value="800">Invest $800 → Earn $4000</option>
            <option value="900">Invest $900 → Earn $4500</option>
            <option value="1000">Invest $1000 → Earn $5000</option>
        </select>
        <button onclick="convertAndPay('vip')">Pay Now</button>
    </div>

    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script>
        function showPlan(plan) {
            document.querySelectorAll('.plan-section').forEach(section => section.classList.remove('active'));
            document.getElementById(plan).classList.add('active');
        }

        async function convertAndPay(plan) {
                const amountUSD = parseFloat(document.getElementById(`amount_${plan}`).value);
                const email = "{{ session.get('user_email', '') }}";

                if (!email) {
                    window.location.href = "/login?next=/invest";  // Redirect to login with return URL
                    return;
                }

                try {
                    // Convert USD to KES
                    const conversionResponse = await fetch(`/convert_currency?amount=${amountUSD}&from=USD&to=KES`);
                    const conversionData = await conversionResponse.json();

                    if (conversionData.error) {
                        // Redirect with error flash message
                        window.location.href = "/invest?error=" + encodeURIComponent(conversionData.error);
                        return;
                    }

                    const amountKES = Math.round(conversionData.converted);

                    // Initialize Paystack payment
                    const paymentResponse = await fetch("/initialize_transaction", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            email: email,
                            amount: amountKES,
                            plan: plan
                        })
                    });

                    const paymentData = await paymentResponse.json();

                    if (paymentData.status && paymentData.data.authorization_url) {
                        window.location.href = paymentData.data.authorization_url;
                    } else {
                        window.location.href = "/invest?error=" + encodeURIComponent(
                            paymentData.message || "Payment initialization failed"
                        );
                    }
                } catch (error) {
                    window.location.href = "/invest?error=" + encodeURIComponent(error.message);
                }
            }

            // For withdrawal button
            async function attemptWithdraw() {
                try {
                    const response = await fetch("/check_withdrawal", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" }
                    });

                    const result = await response.json();

                    if (result.error) {
                        window.location.href = "/dashboard?error=" + encodeURIComponent(result.error);
                        return;
                    }

                    if (!result.can_withdraw) {
                        window.location.href = "/dashboard?info=" + encodeURIComponent(result.message);
                        return;
                    }

                    const paymentResponse = await fetch("/process_withdrawal", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" }
                    });

                    const paymentData = await paymentResponse.json();

                    if (paymentData.status) {
                        window.location.href = paymentData.data.authorization_url;
                    } else {
                        window.location.href = "/dashboard?error=" + encodeURIComponent(
                            paymentData.message || "Withdrawal failed"
                        );
                    }
                } catch (error) {
                    window.location.href = "/dashboard?error=" + encodeURIComponent(error.message);
                }
            }

    </script>

</body>

</html>